<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shop.mapper.ShopMapper">
	<!-- 카테고리별 상품 리스트 : 1차 분류 -->
	<select id="list" resultType="com.shop.domain.GoodsViewVO">
		select g.gdsNum, g.gdsName,
		g.cateCode,
		c.cateCodeRef, c.cateName, gdsPrice, gdsStock, gdsDes,
		gdsImg,
		gdsDate, g.gdsImg, g.gdsThumbImg
		from tbl_goods g
		inner join
		tbl_category c
		on g.cateCode = c.cateCode
		where g.cateCode = #{cateCode}
	</select>


	<select id="home" resultType="com.shop.domain.GoodsViewVO">
		select gdsNum, gdsName, gdsPrice,
		gdsStock, gdsDes,
		gdsImg,
		gdsDate, gdsThumbImg
		from tbl_goods
	</select>

	<select id="goodsView" resultType="com.shop.domain.GoodsViewVO">
		select
		g.gdsNum, g.gdsName,
		g.cateCode, c.cateCode, c.cateCodeRef, c.cateName,
		gdsPrice, gdsStock,
		gdsDes, gdsImg, gdsDate,gdsImgs, g.gdsImg, g.gdsThumbImg , g.gdsCnt
		from tbl_goods
		g
		inner
		join tbl_category c
		on g.cateCode = c.cateCode
		where g.gdsNum =
		#{gdsNum}

	</select>


	<select id="goodViewCnt"
		resultType="com.shop.domain.GoodsViewVO">
		select gdsNum, gdsName, gdsPrice,
		gdsStock, gdsDes,
		gdsImg,
		gdsDate, gdsThumbImg , gdsCnt
		from tbl_goods
		order by gdsCnt desc
	</select>

	<update id="changeGdsCnt">

		UPDATE
		tbl_goods
		SET
		gdsCnt = gdsCnt + 1
		WHERE
		gdsNum =
		#{gdsNum}


	</update>


	<insert id="addCart">
		insert into tbl_cart (cartNum, userId, gdsNum,
		gdsName,
		cartStock)
		values(tbl_cart_seq.nextval, #{userId} , #{gdsNum} ,
		#{gdsName},
		#{cartStock})

	</insert>

	<select id="cartList" resultType="com.shop.domain.CartListVO">
		select
		row_number() over(order
		by c.cartNum desc) as num,
		c.cartNum, c.userId, c.gdsNum, c.cartStock,
		c.addDate,
		g.gdsName, g.gdsPrice, g.gdsThumbImg
		from tbl_cart c
		inner
		join tbl_goods g
		on c.gdsNum = g.gdsNum
		where c.userId =
		#{userId}

	</select>


	<delete id="deleteCart">
		delete tbl_cart
		where cartNum = #{cartNum}
		and userId =
		#{userId}

	</delete>

	<!-- 주문 정보 -->
	<insert id="orderInfo">
		insert into tbl_order(orderId, userId, orderRec,
		userAddr1, userAddr2,
		userAddr3, orderPhon, amount , gdsNames)
		values(#{orderId},
		#{userId}, #{orderRec}, #{userAddr1}, #{userAddr2},
		#{userAddr3},
		#{orderPhon}, #{amount} , #{gdsNames})
	</insert>

	<!-- 주문 상세 정보 -->
	<insert id="orderInfo_Details">
		insert into tbl_order_details(orderDetailsNum,
		orderId, gdsNum, cartStock)
		select tbl_order_details_seq.nextval,
		#{orderId}, gdsNum, cartStock
		from tbl_cart
	</insert>


	<delete id="cartAllDelete">
		delete tbl_cart
		where userId = #{userId}

	</delete>

	<select id="orderList" resultType="com.shop.domain.OrderVO">
		select
		orderId, userId,
		orderRec, userAddr1, userAddr2, userAddr3, orderPhon, amount
		,orderDate ,delivery
		from tbl_order
		where userId = #{userId}

	</select>

	<select id="orderView" resultType="com.shop.domain.OrderListVO">
		select
		o.orderId, o.userId,
		o.orderRec, o.userAddr1, o.userAddr2, o.userAddr3,
		o.orderPhon,
		o.amount, o.orderDate, o.delivery,
		d.orderDetailsNum, d.gdsNum,
		d.cartStock,
		g.gdsName, g.gdsThumbImg, g.gdsPrice
		from tbl_order o
		inner
		join
		tbl_order_details d
		on o.orderId = d.orderId
		inner join tbl_goods g
		on
		d.gdsNum = g.gdsNum
		where o.userId = #{userId}
		and o.orderId =
		#{orderId}



	</select>


	<delete id="orderDelete">





		delete
		from (select t1.orderId , t2.orderdetailsnum
		from
		tbl_order t1 ,
		tbl_order_details
		t2
		where t1.delivery = '주문접수'
		and
		t1.orderId =
		t2.orderId
		)
		where orderId = #{orderId}

	</delete>

	<delete id="orderDelete1">
		delete
		from tbl_order
		where orderId = #{orderId}


	</delete>
</mapper>
